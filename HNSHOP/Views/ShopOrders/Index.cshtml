@model List<HNSHOP.Models.SubOrder>
@using HNSHOP.Utils.EnumTypes
@using System.Globalization

@{
    ViewBag.Title = "Quản lý đơn hàng cửa hàng";
    var vi = CultureInfo.GetCultureInfo("vi-VN");

    var grouped = Model.GroupBy(x => x.Status).ToDictionary(g => g.Key, g => g.ToList());

    var tabStatuses = new List<SubOrderStatus>
    {
        SubOrderStatus.Pending,
        SubOrderStatus.Shipping,
        SubOrderStatus.Delivered,
        SubOrderStatus.Completed,
        SubOrderStatus.Cancelled
    };

    string GetStatusText(SubOrderStatus status) => status switch
    {
        SubOrderStatus.Pending => "Chờ duyệt",
        SubOrderStatus.Shipping => "Đang giao",
        SubOrderStatus.Delivered => "Đã giao",
        SubOrderStatus.Completed => "Đã nhận hàng",
        SubOrderStatus.Cancelled => "Đã hủy",
        _ => status.ToString()
    };

    string GetBadgeClass(SubOrderStatus status) => status switch
    {
        SubOrderStatus.Pending => "secondary",
        SubOrderStatus.Shipping => "info",
        SubOrderStatus.Delivered => "primary",
        SubOrderStatus.Completed => "success",
        SubOrderStatus.Cancelled => "danger",
        _ => "light"
    };
}

<style>
    .tab-pane {
        display: none;
        position: absolute;
        width: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        transition: opacity 0.3s;
    }

        .tab-pane.active {
            display: block;
            position: relative;
            opacity: 1;
        }
</style>
<section id="cart_items">
<div class="container p-5">
    <div class="breadcrumbs">
        <ol class="breadcrumb">
            <li><a asp-controller="Home" asp-action="Index">Home</a></li>
            <li class="active">Quản lý đơn hàng của Shop</li>
        </ol>
    </div>
    <section class="category-tab shop-details-tab">
        <div class="container">

<!-- Tabs -->
<ul class="nav nav-tabs mb-4">
    @for (int i = 0; i < tabStatuses.Count; i++)
    {
        var status = tabStatuses[i];
        var active = i == 0 ? "active" : "";
        <li class="nav-item">
            <a class="nav-link @active" href="javascript:void(0);" onclick="switchTab('@status')">
                @GetStatusText(status)
            </a>
        </li>
    }
</ul>

<div class="tab-content">
    @for (int i = 0; i < tabStatuses.Count; i++)
    {
        var status = tabStatuses[i];
        var active = i == 0 ? "active show" : "";
        var subOrders = grouped.ContainsKey(status) ? grouped[status] : new List<HNSHOP.Models.SubOrder>();

        <div class="tab-pane @active" id="@status">
                            <table class="table table-bordered table-hover shadow-sm" style="border:none; width:95%;">
                <thead class="thead-light">
                    <tr style="background-color:#fbc75e">
                        <th>Mã đơn</th>
                        <th>Khách hàng</th>
                        <th>Trạng thái giao</th>
                        <th>Ngày tạo</th>
                        <th>Tổng tiền</th>
                        <th>Hành động</th>
                    </tr>
                    <tr style="background-color:#ffffff">
                        <td style="border:none;"></td>
                        <td style="border:none;"></td>
                        <td style="border:none;"></td>
                        <td style="border:none;"></td>
                        <td style="border:none;"></td>
                        <td style="border:none;"></td>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var sub in subOrders)
                    {
                        <tr style="background-color:#ffe6b3">
                            <td>@sub.OrderId</td>
                            <td>@sub.Order.Customer.Name</td>
                            <td>
                                <span class="badge badge-@GetBadgeClass(sub.Status)">
                                    @GetStatusText(sub.Status)
                                </span>
                            </td>
                            <td>@sub.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@sub.Total.ToString("N0", vi) đ</td>
                            <td>
                                @if (sub.Status == SubOrderStatus.Pending)
                                {
                                    <form asp-action="ApproveSubOrder" method="post" style="display:inline">
                                        <input type="hidden" name="id" value="@sub.Id" />
                                        <button class="btn btn-sm btn-success mb-1">
                                            <i class="fa fa-check"></i> Duyệt giao hàng
                                        </button>
                                    </form>
                                    <form asp-action="CancelSubOrder" method="post" style="display:inline">
                                        <input type="hidden" name="id" value="@sub.Id" />
                                        <button class="btn btn-sm btn-danger mb-1" onclick="return confirm('Bạn chắc chắn muốn huỷ đơn hàng này?')">
                                            <i class="fa fa-times"></i> Huỷ đơn
                                        </button>
                                    </form>
                                }
                                else if (sub.Status == SubOrderStatus.Shipping)
                                {
                                    <form asp-action="MarkDelivered" method="post" style="display:inline">
                                        <input type="hidden" name="id" value="@sub.Id" />
                                        <button class="btn btn-sm btn-primary mb-1">
                                            <i class="fa fa-truck"></i> Đã giao hàng
                                        </button>
                                    </form>
                                }
                            </td>
                        </tr>

                        <tr style="background-color:#fcf6e9">
                            <td colspan="6" class="p-0">
                                <table class="table table-sm mb-0">
                                    <thead class="thead-light" style="background-color:#fcf6e9">
                                        <tr>
                                            <th>Sản phẩm</th>
                                            <th class="text-center">Số lượng</th>
                                            <th class="text-right">Đơn giá</th>
                                            <th class="text-right">Tạm tính</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in sub.DetailOrders)
                                        {
                                            <tr style="background-color:#f3f1ed">
                                                <td>@((item.Product.Name?.Length > 100) ? item.Product.Name.Substring(0, 100) + "..." : item.Product.Name)</td>
                                                <td class="text-center">@item.Quantity</td>
                                                <td class="text-right">@item.UnitPrice.ToString("N0", vi) đ</td>
                                                <td class="text-right">@((item.UnitPrice * item.Quantity).ToString("N0", vi)) đ</td>
                                            </tr>
                                        }
                                        <tr style="background-color:#fcf6e9">
                                            <td colspan="3"></td>
                                            <td class="text-right">
                                                <a asp-action="SubOrderDetails" asp-route-id="@sub.Id" class="btn btn-info btn-sm">
                                                    <i class="fa fa-eye"></i> Chi tiết
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </td>
                        </tr>

                        <tr style="background-color:#ffffff"><td colspan="6" style="border:none;"></td></tr>
                        <tr style="background-color:#ffffff"><td colspan="6" style="border:none;"></td></tr>
                        <tr style="background-color:#ffffff"><td colspan="6" style="border:none;"></td></tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
</div>
</section>
</div>
</section>
@section Scripts {
    <script>
        function switchTab(id) {
            // Bỏ active ở các tab
            document.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
                pane.classList.remove('show');
            });

            // Kích hoạt tab được chọn
            const nav = Array.from(document.querySelectorAll('.nav-link'))
                             .find(el => el.getAttribute("onclick")?.includes(id));
            if (nav) nav.classList.add('active');

            const content = document.getElementById(id);
            if (content) {
                content.classList.add('active');
                content.classList.add('show');
            }
        }

        // Optional: giữ tab đang mở sau reload (dùng localStorage)
        document.addEventListener('DOMContentLoaded', () => {
            const savedTab = localStorage.getItem('shop-tab');
            if (savedTab) switchTab(savedTab);

            // Ghi lại tab khi click
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    const onclickValue = link.getAttribute("onclick");
                    const match = onclickValue?.match(/switchTab\('(.+?)'\)/);
                    if (match) localStorage.setItem('shop-tab', match[1]);
                });
            });
        });
    </script>
}
