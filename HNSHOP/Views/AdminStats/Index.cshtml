@using Newtonsoft.Json
@{
    ViewData["Title"] = "Thống Kê Sản Phẩm";
    Layout = "_Layout";

    var categoryStats = ViewBag.ProductByCategory as IEnumerable<dynamic>;
    var shopStats = ViewBag.ProductByShop as IEnumerable<dynamic>;
    var topStats = ViewBag.TopSellingProducts as IEnumerable<dynamic>;
    var lowStockStats = ViewBag.LowStockProducts as IEnumerable<dynamic>;
    var hiddenStats = ViewBag.HiddenOrExpiredProducts as IEnumerable<dynamic>;
}

<section id="cart_items">
    <div class="container p-5">
        <div class="breadcrumbs">
            <ol class="breadcrumb">
                <li><a asp-controller="Home" asp-action="Index">Home</a></li>
                <li class="active">Thống kê sản phẩm</li>
            </ol>
        </div>
        <h2 class="title text-center">📊 Thống kê sản phẩm - Tổng  @ViewBag.TotalProducts sản phẩm </h2>
        <div class="table-responsive cart_info">


            <!-- 1. Sản phẩm theo danh mục -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4 class="text-center">Sản phẩm theo danh mục</h4>
                    <br />
                                <table class="table table-condensed">
                        <thead><tr class="cart_menu"><th>Danh mục</th><th>Số lượng</th></tr></thead>
                                        <tbody>
                                            @foreach (var item in categoryStats)
                                            {
                                                <tr><td>@item.CategoryName</td><td>@item.Count</td></tr>
                                            }
                                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <h4 class="text-center">Biểu đồ: Sản phẩm theo danh mục</h4>
                    <br />

                    <canvas id="chartCategory" style="max-height:300px; width:100%;"></canvas>
                </div>
            </div>
            <br />
            <br />
            <hr />
          <!-- 2. Sản phẩm theo shop -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4 class="text-center">Sản phẩm theo shop</h4>
                    <br />

                    <table class="table table-condensed">
                        <thead><tr class="cart_menu"><th>Shop</th><th>Số lượng</th></tr></thead>
                        <tbody>
                            @foreach (var item in shopStats)
                            {
                                <tr><td>@item.ShopName</td><td>@item.Count</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <h4 class="text-center">Biểu đồ: Sản phẩm theo shop</h4>
                    <br />

                    <canvas id="chartShop" style="max-height:300px; width:100%;"></canvas>
                </div>
            </div>
            <br />
            <br />
            <hr />
            <!-- 3. Top sản phẩm bán chạy -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4 class="text-center">Top sản phẩm bán chạy</h4>
                    <br />

                    <table class ="table table-condensed">
                        <thead><tr class="cart_menu"><th>Sản phẩm</th><th>SL</th></tr></thead>
                        <tbody>
                            @foreach (var item in topStats)
                            {
                                <tr><td>@item.ProductName</td><td>@item.Sold</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <h4 class="text-center">Biểu đồ: Top sản phẩm bán chạy</h4>
                    <br />

                    <canvas id="chartTopSelling" style="max-height:300px; width:100%;"></canvas>
                </div>
            </div>
            <br />
            <br />
            <hr />
            <!-- 4. Tồn kho thấp -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4 class="text-center">Sản phẩm tồn kho thấp (&lt; 10)</h4>
                    <br />

                    <table class="table table-condensed">
                        <thead><tr class="cart_menu"><th>Tên</th><th>Shop</th><th>SL</th></tr></thead>
                        <tbody>
                            @foreach (var item in lowStockStats)
                            {
                                <tr><td>@item.Name</td><td>@item.Shop.Name</td><td>@item.Quantity</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <h4 class="text-center">Biểu đồ: Tồn kho thấp</h4>
                    <br />

                    <canvas id="chartLowStock" style="max-height:300px; width:100%;"></canvas>
                </div>
            </div>
            <br />
            <br />
            <hr />
            <!-- 5. Sản phẩm bị ẩn / hết hạn -->
            @if (hiddenStats != null && hiddenStats.Any())
            {
            <div class="row mt-4 mb-5">
                <div class="col-md-6">
                        <h4 class="text-center">Sản phẩm bị ẩn / hết hạn</h4>
                        <br />

                        <table class="table table-condensed">
                            <thead><tr class="cart_menu"><th>Tên</th><th>Danh mục</th><th>Shop</th></tr></thead>
                        <tbody>
                            @foreach (var item in hiddenStats)
                            {
                                <tr><td>@item.Name</td><td>@item.ProductType.Name</td><td>@item.Shop.Name</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                        <h4 class="text-center">Biểu đồ: Sản phẩm bị ẩn / hết hạn</h4>
                        <br />

                    <canvas id="chartHidden" style="max-height:300px; width:100%;"></canvas>
                </div>
            </div>
            }

</div>
</div>
</section>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
            const COLORS = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#2ecc71', '#e74c3c',
                '#3498db', '#9b59b6', '#e67e22', '#1abc9c',
                '#c0392b', '#f1c40f', '#7f8c8d'
            ];

        document.addEventListener('DOMContentLoaded', function () {
            // Chart data bindings
            const categoryStats = @Html.Raw(JsonConvert.SerializeObject(categoryStats));
            const shopStats = @Html.Raw(JsonConvert.SerializeObject(shopStats));
            const topStats = @Html.Raw(JsonConvert.SerializeObject(topStats));
            const lowStock = @Html.Raw(JsonConvert.SerializeObject(((IEnumerable<dynamic>)ViewBag.LowStockProducts).Select(x => new { Name = x.Name, Quantity = x.Quantity })));
            const hiddenStats = @Html.Raw(JsonConvert.SerializeObject(((IEnumerable<dynamic>)ViewBag.HiddenOrExpiredProducts).Select(x => new { Name = x.Name })));

            // Danh mục
            if (categoryStats.length) {
                new Chart(document.getElementById('chartCategory'), {
                    type: 'pie',
                    data: {
                        labels: categoryStats.map(x => x.CategoryName),
                        datasets: [{ data: categoryStats.map(x => x.Count) }]
                    },
                    options: { responsive: true }
                });
            }

            // Shop
            if (shopStats.length) {
                new Chart(document.getElementById('chartShop'), {
                    type: 'bar',
                    data: {
                        labels: shopStats.map(x => x.ShopName),
                        datasets: [{
                            label: 'Sản phẩm',
                            data: shopStats.map(x => x.Count),
                            backgroundColor: topStats.map((_, i) => COLORS[i % COLORS.length])


                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        scales: { x: { beginAtZero: true } }
                    }
                });
            }

            // Top bán chạy
            if (topStats.length) {
                new Chart(document.getElementById('chartTopSelling'), {
                    type: 'bar',
                    data: {
                            labels: topStats.map(x => x.ProductName.length > 30 ? x.ProductName.substring(0, 30) + '...' : x.ProductName),
                            datasets: [{
                            label: 'Đã bán',
                            data: topStats.map(x => x.Sold),
                            backgroundColor: topStats.map((_, i) => COLORS[i % COLORS.length])

                                }]
                    },
                        options: {
                        responsive: true,
                        indexAxis: 'y',
                        scales: {
                            x: { beginAtZero: true }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: (tooltipItems) => {
                                        const index = tooltipItems[0].dataIndex;
                                        return topStats[index].ProductName;
                                    }
                                }
                            }
                        }
        }

                });
            }

            // Tồn kho thấp
            if (lowStock.length) {
                new Chart(document.getElementById('chartLowStock'), {
                    type: 'bar',
                    data: {
                        labels: lowStock.map(x => x.Name.length > 30 ? x.Name.substring(0, 30) + '...' : x.Name),
                        datasets: [{
                            label: 'Tồn kho',
                            data: lowStock.map(x => x.Quantity),
                            backgroundColor: topStats.map((_, i) => COLORS[i % COLORS.length])


                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            }

            // Sản phẩm bị ẩn

            if (hiddenStats.length) {
                new Chart(document.getElementById('chartHidden'), {
                    type: 'bar',
                    data: {
                        labels: hiddenStats.map(x => x.Name),
                        datasets: [{
                            label: 'Bị ẩn / hết hạn',
                            data: hiddenStats.map(x => 1),
                            backgroundColor: topStats.map((_, i) => COLORS[i % COLORS.length])


                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }
        });
    </script>
}
